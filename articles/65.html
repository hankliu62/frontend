<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>卡鲁秋 - 前端小工具</title><link rel="icon" href="/frontend/favicon.ico"/><meta name="description" content="卡鲁秋的前端工具网站，提供了一系列实用的前端开发工具和功能，技术网站汇总，旨在帮助开发者更加高效地进行前端开发。"/><meta name="keywords" content="前端工具,前端开发,前端开发工具,前端开发工具集合,toolbox,frontend,卡鲁秋,Hank,HankLiu"/><meta name="author" content="Hank.Liu"/><meta name="next-head-count" content="7"/><link rel="stylesheet" href="/frontend/styles/animate.css/@4.1.1/animate.css"/><link rel="preload" href="/frontend/_next/static/css/7d86e7558ae79ddf.css" as="style"/><link rel="stylesheet" href="/frontend/_next/static/css/7d86e7558ae79ddf.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/frontend/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script src="/frontend/_next/static/chunks/webpack-00cff57fe07f0499.js" defer=""></script><script src="/frontend/_next/static/chunks/framework-305cb810cde7afac.js" defer=""></script><script src="/frontend/_next/static/chunks/main-b293406bcb5e388b.js" defer=""></script><script src="/frontend/_next/static/chunks/pages/_app-06ea5a3e03de3a16.js" defer=""></script><script src="/frontend/_next/static/chunks/753-a6d5bea35a34c9d2.js" defer=""></script><script src="/frontend/_next/static/chunks/63-1df325007cb4daf2.js" defer=""></script><script src="/frontend/_next/static/chunks/pages/articles/%5Bid%5D-eab77429d5eaa728.js" defer=""></script><script src="/frontend/_next/static/qrQp_9Hjq-HbdXTrdq60c/_buildManifest.js" defer=""></script><script src="/frontend/_next/static/qrQp_9Hjq-HbdXTrdq60c/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="flex h-full min-h-[100vh] w-full flex-col" style="flex-direction:column;min-height:100vh"><main class="flex flex-1 grow-[1] flex-col" style="flex:1"><div class="flex h-full flex-1 flex-col" style="position:relative"><div class="flex space-x-6 bg-white p-6"><div class="flex-1 overflow-x-hidden"><div class="ant-card ant-card-bordered article-card min-h-full !border-[#d9d9d9] css-12jzuas"><div class="ant-card-body"><article><div class="mx-auto mb-[36px] max-w-[1045px] px-[30px] lg:mb-[52px] lg:flex lg:px-0"><div id="banner" class="media-wrapper image-media-wrapper w-full overflow-hidden rounded-[8px] border-[1px] border-solid border-[#1D2129] lg:ml-0 lg:h-[320px] lg:w-[500px]"><div class="hidden before"></div><div class="hidden after"></div><div class="scale-103 h-full w-full border-[8px] border-solid border-white lg:scale-100 cover-wrapper"><img class="h-full w-full rounded-md object-cover cover" src="/frontend/dashboard/images/banner.png" alt=""/></div></div><div class="mt-[60px] overflow-hidden lg:ml-[32px] lg:mt-0 lg:flex-1"><h1 class="leading-130 montserrat-bold mb-[9px] text-[36px] font-medium text-[#1D2129] lg:mb-[8px]">实现Github代码diff效果</h1><div class="mb-[9px] flex whitespace-nowrap lg:mb-[10px]"><div class="leading-120 cursor-pointer truncate text-[24px] font-normal text-[#1D2129] underline-offset-2 hover:underline lg:text-[20px]" aria-hidden="true"># VOL.<!-- -->65</div><div class="leading-120 ml-[48px] text-[24px] font-normal text-[#1D2129] lg:ml-[32px] lg:text-[20px]">2023/03/08</div></div><div class="mb-[12px] flex flex-wrap lg:mb-0"><div class="leading-150 mb-[12px] mr-[18px] rounded-[30px] border border-solid border-[#1D2129] px-[24px] py-[6px] text-[20px] font-normal text-[#1D2129] lg:mb-[12px] lg:mr-[10px] lg:rounded-[20px] lg:px-[16px] lg:py-[4px] lg:text-[14px]">blog</div><div class="leading-150 mb-[12px] mr-[18px] rounded-[30px] border border-solid border-[#1D2129] px-[24px] py-[6px] text-[20px] font-normal text-[#1D2129] lg:mb-[12px] lg:mr-[10px] lg:rounded-[20px] lg:px-[16px] lg:py-[4px] lg:text-[14px]">component</div></div><div class="my-[30px] hidden w-[213px] border border-[#1D2129] lg:mb-[20px] lg:mt-[8px] lg:block"></div><div class="lg:rounded-0 rounded-[12px] bg-white/30 p-[36px] lg:flex lg:bg-transparent lg:p-0"><div class="float-left h-[118px] w-[118px] lg:float-none lg:h-[112px] lg:w-[112px]"><img src="https://avatars.githubusercontent.com/u/8088864?v=4" class="h-full w-full rounded-[8px] object-cover lg:rounded-[12px]" alt=""/></div><div class="lg:ml-[32px] lg:flex-1 lg:overflow-hidden"><div class="mb-[10px] flex h-[118px] flex-col justify-center pl-[36px] lg:h-auto lg:flex-row lg:items-center lg:justify-between lg:pl-0"><div class="leading-130 montserrat-bold mb-[12px] w-full truncate text-[30px] font-medium text-[#1D2129] lg:mb-0 lg:flex-1 lg:text-[24px]">hankliu62</div><a class="leading-170 ml-0 whitespace-pre-wrap text-[20px] font-normal !text-[#1D2129] !underline hover:!text-[#1D2129] hover:!underline focus:!text-[#1D2129] lg:ml-[5px] lg:text-[14px]" href="https://github.com/hankliu62" target="_blank" rel="noreferrer">TA的个人名片</a></div><div class="leading-170 text-[20px] font-normal text-[#4E5969] lg:text-[14px]">HankLiu前端开发工程师，精通前端，涉猎后端，对前端有着浓厚的兴趣，希望能够在前端这条路上一直走下去。努力去听风的声音，不必在意风的方向。</div></div></div></div></div><div class="ant-divider css-12jzuas ant-divider-horizontal !mt-0 !border-[#bfc3c7]" role="separator"></div><section><div><div class="ant-skeleton ant-skeleton-active css-12jzuas"><div class="ant-skeleton-content"><h3 class="ant-skeleton-title" style="width:38%"></h3><ul class="ant-skeleton-paragraph"><li></li><li></li><li style="width:61%"></li></ul></div></div></div></section></article></div></div></div><div class="w-64 bg-white"><div><div class=""><div class="ant-collapse ant-collapse-icon-position-end question-menus-collapse css-12jzuas"><div class="ant-collapse-item ant-collapse-item-active"><div class="ant-collapse-header" aria-expanded="true" aria-disabled="false" role="button" tabindex="0"><div class="ant-collapse-expand-icon"><span role="img" aria-label="right" class="anticon anticon-right ant-collapse-arrow"><svg viewBox="64 64 896 896" focusable="false" style="-ms-transform:rotate(90deg);transform:rotate(90deg)" data-icon="right" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M765.7 486.8L314.9 134.7A7.97 7.97 0 00302 141v77.3c0 4.9 2.3 9.6 6.1 12.6l360 281.1-360 281.1c-3.9 3-6.1 7.7-6.1 12.6V883c0 6.7 7.7 10.4 12.9 6.3l450.8-352.1a31.96 31.96 0 000-50.4z"></path></svg></span></div><span class="ant-collapse-header-text"><span class="text-base">目录</span></span><div class="ant-collapse-extra"><div class="-mr-2">收起</div></div></div><div class="ant-collapse-content ant-collapse-content-active"><div class="ant-collapse-content-box"><ul class="max-h-[620px] list-none space-y-3 overflow-y-auto text-slate-500 dark:text-slate-400"><li id="## 背景" class="border-0 !border-l-2 border-solid border-transparent pr-[16px] text-base !border-sky-500"><a class="w-full overflow-hidden !text-[#515767] !text-sky-500" href="/frontend/articles/65#%E8%83%8C%E6%99%AF"><div class="truncate" style="padding-left:16px">背景</div></a></li><li id="## 问题" class="border-0 !border-l-2 border-solid border-transparent pr-[16px] text-base"><a class="w-full overflow-hidden !text-[#515767] !hover:text-slate-600 !dark:hover:text-slate-300" href="/frontend/articles/65#%E9%97%AE%E9%A2%98"><div class="truncate" style="padding-left:16px">问题</div></a></li><li id="## 解决方案" class="border-0 !border-l-2 border-solid border-transparent pr-[16px] text-base"><a class="w-full overflow-hidden !text-[#515767] !hover:text-slate-600 !dark:hover:text-slate-300" href="/frontend/articles/65#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><div class="truncate" style="padding-left:16px">解决方案</div></a></li><li id="### 技术选择" class="border-0 !border-l-2 border-solid border-transparent pr-[16px] text-base"><a class="w-full overflow-hidden !text-[#515767] !hover:text-slate-600 !dark:hover:text-slate-300" href="/frontend/articles/65#%E6%8A%80%E6%9C%AF%E9%80%89%E6%8B%A9"><div class="truncate" style="padding-left:32px">技术选择</div></a></li><li id="### diff" class="border-0 !border-l-2 border-solid border-transparent pr-[16px] text-base"><a class="w-full overflow-hidden !text-[#515767] !hover:text-slate-600 !dark:hover:text-slate-300" href="/frontend/articles/65#diff"><div class="truncate" style="padding-left:32px">diff</div></a></li><li id="#### 安装" class="border-0 !border-l-2 border-solid border-transparent pr-[16px] text-base"><a class="w-full overflow-hidden !text-[#515767] !hover:text-slate-600 !dark:hover:text-slate-300" href="/frontend/articles/65#%E5%AE%89%E8%A3%85"><div class="truncate" style="padding-left:48px">安装</div></a></li><li id="#### 引用" class="border-0 !border-l-2 border-solid border-transparent pr-[16px] text-base"><a class="w-full overflow-hidden !text-[#515767] !hover:text-slate-600 !dark:hover:text-slate-300" href="/frontend/articles/65#%E5%BC%95%E7%94%A8"><div class="truncate" style="padding-left:48px">引用</div></a></li><li id="#### API" class="border-0 !border-l-2 border-solid border-transparent pr-[16px] text-base"><a class="w-full overflow-hidden !text-[#515767] !hover:text-slate-600 !dark:hover:text-slate-300" href="/frontend/articles/65#api"><div class="truncate" style="padding-left:48px">API</div></a></li><li id="#### 原理" class="border-0 !border-l-2 border-solid border-transparent pr-[16px] text-base"><a class="w-full overflow-hidden !text-[#515767] !hover:text-slate-600 !dark:hover:text-slate-300" href="/frontend/articles/65#%E5%8E%9F%E7%90%86"><div class="truncate" style="padding-left:48px">原理</div></a></li><li id="### diff2html" class="border-0 !border-l-2 border-solid border-transparent pr-[16px] text-base"><a class="w-full overflow-hidden !text-[#515767] !hover:text-slate-600 !dark:hover:text-slate-300" href="/frontend/articles/65#diff2html"><div class="truncate" style="padding-left:32px">diff2html</div></a></li><li id="#### 安装" class="border-0 !border-l-2 border-solid border-transparent pr-[16px] text-base"><a class="w-full overflow-hidden !text-[#515767] !hover:text-slate-600 !dark:hover:text-slate-300" href="/frontend/articles/65#%E5%AE%89%E8%A3%85"><div class="truncate" style="padding-left:48px">安装</div></a></li><li id="#### 引用" class="border-0 !border-l-2 border-solid border-transparent pr-[16px] text-base"><a class="w-full overflow-hidden !text-[#515767] !hover:text-slate-600 !dark:hover:text-slate-300" href="/frontend/articles/65#%E5%BC%95%E7%94%A8"><div class="truncate" style="padding-left:48px">引用</div></a></li><li id="#### 使用" class="border-0 !border-l-2 border-solid border-transparent pr-[16px] text-base"><a class="w-full overflow-hidden !text-[#515767] !hover:text-slate-600 !dark:hover:text-slate-300" href="/frontend/articles/65#%E4%BD%BF%E7%94%A8"><div class="truncate" style="padding-left:48px">使用</div></a></li></ul></div></div></div></div></div></div></div></div></div><div style="position:fixed;z-index:9999;top:16px;left:16px;right:16px;bottom:16px;pointer-events:none"></div></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"article":{"url":"https://api.github.com/repos/hankliu62/hankliu62.github.com/issues/65","repository_url":"https://api.github.com/repos/hankliu62/hankliu62.github.com","labels_url":"https://api.github.com/repos/hankliu62/hankliu62.github.com/issues/65/labels{/name}","comments_url":"https://api.github.com/repos/hankliu62/hankliu62.github.com/issues/65/comments","events_url":"https://api.github.com/repos/hankliu62/hankliu62.github.com/issues/65/events","html_url":"https://github.com/hankliu62/hankliu62.github.com/issues/65","id":1615016227,"node_id":"I_kwDOBiJZIc5gQzEj","number":65,"title":"实现Github代码diff效果","user":{"login":"hankliu62","id":8088864,"node_id":"MDQ6VXNlcjgwODg4NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/8088864?v=4","gravatar_id":"","url":"https://api.github.com/users/hankliu62","html_url":"https://github.com/hankliu62","followers_url":"https://api.github.com/users/hankliu62/followers","following_url":"https://api.github.com/users/hankliu62/following{/other_user}","gists_url":"https://api.github.com/users/hankliu62/gists{/gist_id}","starred_url":"https://api.github.com/users/hankliu62/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hankliu62/subscriptions","organizations_url":"https://api.github.com/users/hankliu62/orgs","repos_url":"https://api.github.com/users/hankliu62/repos","events_url":"https://api.github.com/users/hankliu62/events{/privacy}","received_events_url":"https://api.github.com/users/hankliu62/received_events","type":"User","site_admin":false},"labels":[{"id":688950687,"node_id":"MDU6TGFiZWw2ODg5NTA2ODc=","url":"https://api.github.com/repos/hankliu62/hankliu62.github.com/labels/blog","name":"blog","color":"1677ff","default":false,"description":"博客文章"},{"id":6795315083,"node_id":"LA_kwDOBiJZIc8AAAABlQhHiw","url":"https://api.github.com/repos/hankliu62/hankliu62.github.com/labels/component","name":"component","color":"f9d0c4","default":false,"description":"Web UI组件/类库相关"}],"state":"open","locked":false,"assignee":{"login":"hankliu62","id":8088864,"node_id":"MDQ6VXNlcjgwODg4NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/8088864?v=4","gravatar_id":"","url":"https://api.github.com/users/hankliu62","html_url":"https://github.com/hankliu62","followers_url":"https://api.github.com/users/hankliu62/followers","following_url":"https://api.github.com/users/hankliu62/following{/other_user}","gists_url":"https://api.github.com/users/hankliu62/gists{/gist_id}","starred_url":"https://api.github.com/users/hankliu62/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hankliu62/subscriptions","organizations_url":"https://api.github.com/users/hankliu62/orgs","repos_url":"https://api.github.com/users/hankliu62/repos","events_url":"https://api.github.com/users/hankliu62/events{/privacy}","received_events_url":"https://api.github.com/users/hankliu62/received_events","type":"User","site_admin":false},"assignees":[{"login":"hankliu62","id":8088864,"node_id":"MDQ6VXNlcjgwODg4NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/8088864?v=4","gravatar_id":"","url":"https://api.github.com/users/hankliu62","html_url":"https://github.com/hankliu62","followers_url":"https://api.github.com/users/hankliu62/followers","following_url":"https://api.github.com/users/hankliu62/following{/other_user}","gists_url":"https://api.github.com/users/hankliu62/gists{/gist_id}","starred_url":"https://api.github.com/users/hankliu62/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hankliu62/subscriptions","organizations_url":"https://api.github.com/users/hankliu62/orgs","repos_url":"https://api.github.com/users/hankliu62/repos","events_url":"https://api.github.com/users/hankliu62/events{/privacy}","received_events_url":"https://api.github.com/users/hankliu62/received_events","type":"User","site_admin":false}],"milestone":null,"comments":0,"created_at":"2023-03-08T10:12:53Z","updated_at":"2024-04-08T05:19:51Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"## 背景\r\n\r\n公司运维需要记录每次修改 yaml 格式模版配置的记录，同时需要非常直观的了解两次修改记录之间的差异，需要类似于 github 代码变更差异的展示的组件。\r\n\r\n![yaml格式模版配置差异对比](https://user-images.githubusercontent.com/8088864/223602720-65e41820-1888-442f-8532-38de512e7ea7.jpg)\r\n\r\n## 问题\r\n\r\n1. 文本内容差异对比实现介绍\r\n\r\n直观的给出两个文件或者两个字符串，我们需要获得两个文件的差异信息。\r\n\r\n2. 将差异转化为 HTML\r\n\r\n当解决上述问题后，我们需要奖差异信息转化成 HTML 进行展示，方便直观的获得其修改差异。\r\n\r\n## 解决方案\r\n\r\n### 技术选择\r\n\r\n[diff](https://www.npmjs.com/package/diff) + [diff2html](https://www.npmjs.com/package/diff2html)\r\n\r\n### diff\r\n\r\n`diff` 是一个基于 javascript 实现的文本内容 diff 的库。它基于已发表论文中的算法 [An O(ND) Difference Algorithm and its Variations\" (Myers, 1986)](https://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.4.6927).\r\n\r\n这个库功能十分强大，不仅能够简洁地输出字符串结果，也能够输出规范化的数据结构方便二次开发。\r\n\r\n#### 安装\r\n\r\n```bash\r\nnpm install diff --save\r\n\r\n# or\r\n\r\nyarn add diff\r\n```\r\n\r\n#### 引用\r\n\r\n```ts\r\nimport {\r\n  diffChars,\r\n  diffWords,\r\n  diffWordsWithSpace,\r\n  diffLines,\r\n  diffTrimmedLines,\r\n  diffSentences,\r\n  diffCss,\r\n  diffJson,\r\n  diffArrays,\r\n  canonicalize,\r\n  applyPatch,\r\n  applyPatches,\r\n  parsePatch,\r\n  merge,\r\n  structuredPatch,\r\n  createTwoFilesPatch,\r\n  createPatch,\r\n  convertChangesToDMP,\r\n  convertChangesToXML,\r\n} from \"diff\";\r\n```\r\n\r\n#### API\r\n\r\n- **`diffChars(oldStr, newStr[, options])`** 这个方法将比较两段文字，比较的维度是基于单个字符\r\n  返回一个由描述改变的对象组成的列表。大致如下：\r\n  ![结果一](https://user-images.githubusercontent.com/8088864/223605269-84cf776e-f991-4002-a5ba-eb8fa28e11fc.png)\r\n\r\n  `added`表示是否是添加内容，`removed`表示是否为删除内容。共有的内容这两个属性都没有，`value`表示内容，`count`表示字符的个数（在某些用法中表示内容的行数）\r\n  可选的配置属性`ignoreCase`: 标记为 true 时忽略字符的大小写，默认为 false，这里给出一个测试例子：\r\n  ![测试例子](https://user-images.githubusercontent.com/8088864/223605416-398121a4-70e5-4782-bd60-d6f4314d32be.png)\r\n\r\n- **`diffWords(oldStr, newStr[, options])`** 该方法比较两段文字，比较的维度是单词，忽略空格，返回一个由描述改变对象组成的列表，可选的配置属性 ignoreCase: 同 diffChars 中一样，这里给出一个使用例子：\r\n  ![image](https://user-images.githubusercontent.com/8088864/223605628-6b2531cc-e38a-4153-9ee1-5f0f9d693baa.png)\r\n\r\n- **`diffWordsWithSpace(oldStr, newStr[, options])`** 该方法比较两段文字，比较的维度是单词，同上一个方法不同的是，它将比较空格的差异，返回一个由描述改变的对象组成的列表。这里给出一个例子：\r\n  ![image](https://user-images.githubusercontent.com/8088864/223605729-1b864451-4b8b-462d-bd96-70308de44d3e.png)\r\n\r\n- **`diffLines(oldStr, newStr[, options])`** 比较两段文字，比较的维度是行。可选的配置项：\r\n\r\n  - `ignoreWhitespace`: 设置为 true 时，将忽略开头和结尾处的空格，在 diffTrimmedLines 中也有这个配置。\r\n  - `newlineIsToken`: 设置为 true 时，将换行符看作是分隔符。这样就可以独立于行内容对换行结构进行更改，并将其视为独立的(原文:This allows for changes to the newline structure to occur independently of the line content and to be treated as such, 这一句是机翻的，感觉不大准确)。总得来说，这样使得`diffLines`的输出对人类阅读(相较于其他对计算机更为友好的输出方式)更为友好，更加方便于比较差异。返回一个由描述改变的对象组成的列表。（这里返回的 obj 列表中，`count`表示这段内容的行数，下面的方法类似），接下来展示一个例子：\r\n    ![image](https://user-images.githubusercontent.com/8088864/223605934-3da43e6b-ed37-414c-bb6c-e07764a72b38.png)\r\n\r\n- **`diffTrimmedLines(oldStr, newStr[, options])`** 比较两段文字，比较的维度是行，忽略开头和结尾处的空格，返回一个由描述改变的对象组成的列表。实例截图：\r\n  ![image](https://user-images.githubusercontent.com/8088864/223606123-672b5706-55e5-4611-b3cc-439f93d14387.png)\r\n\r\n- **`diffSentences(oldStr, newStr[, options])`** 比较两段文字，比较的维度是句子。返回一个由描述改变的对象组成的列表。实例截图：\r\n  ![image](https://user-images.githubusercontent.com/8088864/223606217-ed47042d-1f82-41d2-bfbf-995c10bd77b3.png)\r\n\r\n- **`diffCss(oldStr, newStr[, options])`** 比较两段内容，比较基于 css 中的相关符号和语法。返回一个由描述改变的对象组成的列表。\r\n\r\n- **`diffJson(oldObj, newObj[, options])`** 比较两个 JSON 对象，比较基于对象内部的 key。这些 key 在 json 对象内的顺序，在比较时将不会影响结果。返回一个由描述改变的对象组成的列表。实例截图：\r\n  ![image](https://user-images.githubusercontent.com/8088864/223606377-4b1642a5-4ce4-48db-82a2-97a9da48d682.png)\r\n\r\n- **`diffArrays(oldArr, newArr[, options])`** 比较两个数组，每一个元素使用严格等于来判定(===)。可选参数：`comparator`: function(left, right)用来进行相等性的比较，返回一个由描述改变的对象组成的列表。\r\n\r\n- **`createTwoFilesPatch(oldFileName, newFileName, oldStr, newStr, oldHeader, newHeader)`** 创造一个统一的 diff 补丁输出。参数：\r\n\r\n  - `oldFileName`: 移除内容在文件名部分输出的字符串\r\n  - `newFileName`: 增添内容在文件名部分输出的字符串\r\n  - `oldStr`: 原始的字符串(作为基准)\r\n  - `newStr`: 比较内容的字符串\r\n  - `oldHeader`: 在老文件头部新增的信息\r\n  - `newHeader`: 在新文件头部新增的信息\r\n  - `options`: 一个描述配置的对象，目前仅支持 context,用来描述应该展示 context 的多少行\r\n\r\n  这里展示一个例子：\r\n\r\n  ![image](https://user-images.githubusercontent.com/8088864/223606656-b467bd67-6695-4fc0-8f5c-463be6988d32.png)\r\n\r\n  这里可以看到，该方法返回的是已经格式化的可直接输出的字符串，方便直接展示。\r\n\r\n- **`createPatch(fileName, oldStr, newStr, oldHeader, newHeader)`** 创造一个统一的 diff 补丁输出,该方法的使用和`createTwoFilesPatch`几乎一致，唯一的区别是`oldFileName`等于`newFileName`\r\n\r\n- **`structuredPatch(oldFileName, newFileName, oldStr, newStr, oldHeader, newHeader, options)`** 返回一个由描述具体变化的对象构成的数组。这个方法类似于`createTwoFilesPatch`，但是返回了一个适合于开发者后续处理的数据结构。其参数跟`createTwoFilesPatch`保持一致，返回的数据类似于如下：\r\n  ![image](https://user-images.githubusercontent.com/8088864/223607353-06c46a1c-3bc8-4cc3-b569-d72db0930957.png)\r\n\r\n  与之对应的应用实例如下：\r\n\r\n  ![image](https://user-images.githubusercontent.com/8088864/223607423-eb8da3a2-c7af-4868-81f3-1dd95c16a9d7.png)\r\n\r\n- **`applyPatch(source, patch[, options])`** 使用一个统一的 diff 补丁。该方法会返回一个应用了补丁的新版本字符串。这里的补丁（patch）可能是字符串形式的 diff 或者`parsePatch`和`structuredPatch`方法返回的输出。可选的配置项有如下：\r\n\r\n  - `fuzzFactor`: 拒绝应用补丁之前允许比较的内容的行数。默认是 0\r\n  - `compareLine(lineNumber, line, operation, patchContent)`: 用来比较给定的行内容在应用补丁时是否应该被认定为相等。默认是使用严格相等来比较的，但是这容易与 fuzzier 比较相冲突。当内容应该被拒绝时返回 false。\r\n\r\n- **`applyPatches(patch[, options])`** 应用一个或者多个补丁。这个方法将会迭代补丁的内容并且将其应用在回调中传入的内容上。每个补丁被使用的整体工作流程是。可选的配置项有如下：\r\n\r\n  - `loadFile(index, callback)`: 调用者应该加载文件的内容并且将其传递给回调（callback(err, data)）。传入一个 err 将会中断未来补丁的执行\r\n  - `patched(index, content, callback)`: 该方法在每个补丁被使用时调用。传入一个 err 将会中断未来补丁的执行\r\n\r\n- **`parsePatch(diffStr)`** 将一个补丁解析为结构化数据。返回一个由补丁解析而来的 JSON 对象，该方法适合同`applyPatch`配合使用。该方法返回的内容同`structuredPatch`返回的内容结构上一致。\r\n\r\n- **`convertChangesToXML(changes)`** 转换一个 changes 的列表到序列化的 XML 格式\r\n\r\n以上的所有可以接受一个可选的回调的方法，在该参数(callback)被省略时该方法工作在同步模式，当这个参数被传入时工作在异步模式。这使得能够处理更大的范围 diff 而不会使得事件流被长期挂起。callback 要么作为最后一个参数被直接传入要么作为 options 中的一个属性被传入。\r\n\r\n#### 原理\r\n\r\n**`抽象`**\r\n\r\n**`寻找 diff 的过程可以被抽象为图搜索。`**\r\n\r\n以两个字符串，src=ABCABBA，dst=CBABAC 为例，根据这两个字符串我们可以构造下面一张图，横轴是 src 内容，纵轴是 dst 内容。\r\n\r\n那么，图中每一条从左上角到右下角的路径，都表示一个 diff。向右表示“删除”，向下表示”新增“，对角线则表示“原内容保持不动“。\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/223632159-33dddec5-7d01-4e88-b0ee-3fe445c4146f.png)\r\n\r\n根据图中形成的线路，我们可以选择一条路径看看它的效果。\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/223632262-c67ac1b1-8598-4070-acd7-d31e397fc11e.png)\r\n\r\n现在，“寻找 diff” 这件事，被抽象成了“寻找图的路径”了。那么，“最短的直观的” diff 对应的路径有什么特点呢？\r\n\r\n- 路径长度最短（对角线不算长度）\r\n\r\n- 先向右，再向下（先删除，后新增）\r\n\r\n**`Myers 算法`**\r\n\r\nMyers 算法就是一个能在大部分情况产生”最短的直观的“ diff 的一个算法，算法原理如下。\r\n\r\n首先，定义参数 d 和 k，d 代表路径的长度，k 代表当前坐标 x - y 的值。定义一个”最优坐标“的概念，最优坐标表示 d 和 k 值固定的情况下，x 值最大的坐标。x 大，表示向右走的多，表示优先删除。\r\n\r\n还是用上面那张图为例。我们从坐标 (0, 0) 开始，此时，d=0，k=0，然后逐步增加 d，计算每个 k 值下对应的最优坐标。\r\n\r\n因为每一步要么向右（x + 1），要么向下（y + 1），对角线不影响路径长度，所以，当 d=1 时，k 只可能有两个取值，要么是 1，要么是 -1。\r\n\r\n当 d=1，k=1 时，最优坐标是 (1, 0)。\r\n\r\n当 d=1，k=-1 时，最优坐标是 (0, 1)。\r\n\r\n因为 d=1 时，k 要么是 1，要么是 -1，当 d=2 时，表示在 d=1 的基础上再走一步，k 只有三个可能的取值，分别是 -2，0，2。\r\n\r\n当 d=2，k=-2 时，最优坐标是 (2, 4)。\r\n\r\n当 d=2，k=0 时，最优坐标是 (2, 2)。\r\n\r\n当 d=2，k=2 时，最优坐标是 (3, 1)。\r\n\r\n以此类推，直到我们找到一个 d 和 k 值，达到最终的目标坐标 (7, 6)。\r\n\r\n下图横轴代表 d，纵轴代表 k，中间是最优坐标，从这张图可以清晰的看出，当 d=5，k=1 时，我们到达了目标坐标 (7, 6)，因此，”最短的直观的“路径就是 (0, 0) -\u003e (1, 0) -\u003e (3, 1) -\u003e (5, 4) -\u003e (7, 5) -\u003e (7, 6)。\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/223632436-447c74fa-63a6-4f12-af41-cf11f32cb718.png)\r\n\r\nMyers 算法是一个典型的”动态规划“算法，也就是说，父问题的求解归结为子问题的求解。要知道 d=5 时所有 k 对应的最优坐标，必须先要知道 d=4 时所有 k 对应的最优坐标，要知道 d=4 时的答案，必须先求解 d=3，以此类推。\r\n\r\n**`Myers 算法基本流程`**\r\n\r\n1. 迭代 d，d 的取值范围为 0 到 n+m，其中 n 和 m 分别代表源文本和目标文本的长度（这里我们选择以行为单位）\r\n\r\n2. 每个 d 内部，迭代 k，k 的取值范围为 -d 到 d，以 2 为步长，也就是 -d，-d + 2，-d + 2 + 2…\r\n\r\n3. 使用一个字典 v，以 k 值为索引，存储最优坐标的 x 值\r\n\r\n4. 将每个 d 对应的 v 字典存储起来，后面回溯的时候需要用\r\n\r\n5. 当我们找到一个 d 和 k，到达目标坐标 (n, m) 时就跳出循环\r\n\r\n6. 使用上面存储的 v 字典（每个 d 对应一个这样的字典），从终点反向得出路径\r\n\r\n### diff2html\r\n\r\n将差异转化为 html。\r\n\r\n#### 安装\r\n\r\n```bash\r\nnpm install diff2html --save\r\n\r\nyarn add diff2html\r\n```\r\n\r\n#### 引用\r\n\r\n```ts\r\nimport { html, parse } from \"diff2html\";\r\nimport {\r\n  Diff2HtmlUI,\r\n  Diff2HtmlUIConfig,\r\n} from \"diff2html/lib/ui/js/diff2html-ui\";\r\n```\r\n\r\n#### 使用\r\n\r\ndiff2html 提供了 2 种方式展示 diff 效果：\r\n\r\n1. parse+html\r\n\r\n问题：highlight 语法高亮不生效。\r\n\r\n2. diff2html-ui:\r\n\r\n\u003e 支持 json、代码高亮。\r\n\r\n\u003e 支持文件目录概要显示/隐藏。\r\n\r\n\u003e 支持收起已查看文件（side-by-side 模式下，viewed 功能失效）。\r\n\r\ndiff2html 格式化类型：side-by-side、line-by-line。\r\n\r\n**`组件`**\r\n\r\n```ts\r\n// diffDataList 对比文件列表数据 [ {...diffDataItem} ]\r\n// diffDataItem :\r\n// {\r\n//   prevData: any(string、json), // 旧数据\r\n//   newData: any(string、json),  // 新数据\r\n//   isYaml?: boolean,            // 是否yaml文件\r\n//   isJson?: boolean,            // 是否json\r\n//   fileName?: string,           // 文件名\r\n//   oldHeader?: string,          // 重命名，旧文件名\r\n//   newHeader?: string           // 重命名，新文件名\r\n// },\r\n// outputFormat diff格式，line-by-line || side-by-side\r\n// isUseUi 是否使用Diff2HtmlUI\r\n// id Diff2HtmlUI 挂载html的id，多实例的情况下，各个实例需要唯一id，防止页面冲突\r\n// fileListToggle Diff2HtmlUI 文件目录概要是否要隐藏，true显示，false隐藏\r\n\r\nimport \"highlight.js/styles/googlecode.css\";\r\nimport \"diff2html/bundles/css/diff2html.min.css\";\r\n\r\nimport { Radio } from \"antd\";\r\nimport { createPatch } from \"diff\";\r\nimport { html, parse } from \"diff2html\";\r\nimport {\r\n  Diff2HtmlUI,\r\n  Diff2HtmlUIConfig,\r\n} from \"diff2html/lib/ui/js/diff2html-ui\";\r\nimport yaml from \"js-yaml\";\r\nimport React, { useEffect, useState } from \"react\";\r\n\r\nexport interface IDiffCodeProps extends Partial\u003cDiff2HtmlUIConfig\u003e {\r\n  isUseUi?: boolean; // 是否使用Diff2HtmlUI\r\n  id?: string; // Diff2HtmlUI 挂载html的id，多实例的情况下，各个实例需要唯一id，防止页面冲突\r\n  diffDataList: {\r\n    prevData: string; // 旧数据\r\n    newData: string; // 新数据\r\n    isYaml?: boolean; // 是否yaml文件\r\n    isJson?: boolean; // 是否json\r\n    fileName?: string; // 文件名\r\n    oldHeader?: string; // 重命名，旧文件名\r\n    newHeader?: string; // 重命名，新文件名\r\n  }[];\r\n  title: string;\r\n  icon?: React.ReactNode;\r\n  headerExtraRender?: () =\u003e React.ReactNode;\r\n}\r\n\r\nconst DiffCode = ({\r\n  diffDataList,\r\n  isUseUi,\r\n  id,\r\n  title,\r\n  icon,\r\n  headerExtraRender,\r\n  ...config\r\n}: IDiffCodeProps) =\u003e {\r\n  const [diffData, setDiffData] = useState(\"\");\r\n\r\n  const [outputFormat, setOutputFormat] = useState\u003c\r\n    Diff2HtmlUIConfig[\"outputFormat\"]\r\n  \u003e(config.outputFormat || \"line-by-line\");\r\n\r\n  useEffect(() =\u003e {\r\n    const diffJsonList = [];\r\n    for (const item of diffDataList) {\r\n      const {\r\n        fileName,\r\n        oldHeader,\r\n        newHeader,\r\n        prevData,\r\n        newData,\r\n        isJson,\r\n        isYaml,\r\n      } = item;\r\n      let oldString = prevData || \"\";\r\n      let newString = newData || \"\";\r\n      // 特定需求处理\r\n      if (isYaml) {\r\n        // 将json转化为yaml格式\r\n        oldString = yaml.dump(prevData);\r\n        newString = yaml.dump(newData);\r\n      } else if (isJson) {\r\n        // 格式化json\r\n        oldString = JSON.stringify(prevData, null, 2);\r\n        newString = JSON.stringify(newData, null, 2);\r\n      }\r\n      const args = [\r\n        fileName || \"\",\r\n        oldString,\r\n        newString,\r\n        oldHeader || \"\",\r\n        newHeader || \"\",\r\n        { context: 99_999 },\r\n      ];\r\n      // 对比差异\r\n      const diffStr = createPatch(...args);\r\n      // 差异json化\r\n      const diffJson = parse(diffStr);\r\n\r\n      diffJsonList.push(diffJson[0]);\r\n    }\r\n    if (isUseUi) {\r\n      // 使用diff2html-ui\r\n      // eslint-disable-next-line unicorn/prefer-query-selector\r\n      const targetElement = document.getElementById(id);\r\n      const configuration: Diff2HtmlUIConfig = {\r\n        ...config,\r\n        drawFileList: true,\r\n        matching: \"lines\",\r\n        highlight: true,\r\n        outputFormat,\r\n      };\r\n      const diff2htmlUi = new Diff2HtmlUI(\r\n        targetElement,\r\n        diffJsonList,\r\n        configuration\r\n      );\r\n      diff2htmlUi.draw(); //绘制页面\r\n      diff2htmlUi.highlightCode(); // 高亮数据\r\n      diff2htmlUi.fileListToggle(!!configuration.fileListToggle); // 是否折叠概要\r\n    } else {\r\n      // 使用html方法\r\n      const diffHtml = html(diffJsonList, {\r\n        ...config,\r\n        drawFileList: false,\r\n        matching: \"lines\",\r\n        outputFormat,\r\n      });\r\n      setDiffData(diffHtml);\r\n    }\r\n  }, [diffDataList, id, isUseUi, config, outputFormat]);\r\n\r\n  return (\r\n    \u003cdiv\u003e\r\n      \u003cdiv className=\"flex items-center justify-between rounded-tl-[4px] rounded-tr-[4px] border border-[#d8d8d8] bg-[#eff4f9] p-3\"\u003e\r\n        \u003cdiv className=\"flex items-center\"\u003e\r\n          \u003cdiv className=\"mr-2 last:mr-0 empty:hidden\"\u003e{icon}\u003c/div\u003e\r\n          \u003cdiv className=\"mr-2 text-sm last:mr-0 empty:hidden\"\u003e{title}\u003c/div\u003e\r\n          \u003cdiv className=\"mr-2 text-sm last:mr-0\"\u003e\r\n            \u003cRadio.Group\r\n              value={outputFormat}\r\n              onChange={(e) =\u003e setOutputFormat(e.target.value)}\r\n            \u003e\r\n              \u003cRadio.Button value=\"line-by-line\"\u003eInline\u003c/Radio.Button\u003e\r\n              \u003cRadio.Button value=\"side-by-side\"\u003eSide-by-side\u003c/Radio.Button\u003e\r\n            \u003c/Radio.Group\u003e\r\n          \u003c/div\u003e\r\n        \u003c/div\u003e\r\n        \u003cdiv className=\"empty:hidden\"\u003e\r\n          {headerExtraRender \u0026\u0026 headerExtraRender()}\r\n        \u003c/div\u003e\r\n      \u003c/div\u003e\r\n      {isUseUi ? (\r\n        \u003cdiv id={id || \"code-diff-ui\"} /\u003e\r\n      ) : (\r\n        \u003cdiv id=\"code-diff\" dangerouslySetInnerHTML={{ __html: diffData }} /\u003e\r\n      )}\r\n    \u003c/div\u003e\r\n  );\r\n};\r\n\r\nexport default DiffCode;\r\n```\r\n\r\n效果如下:\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/223684264-394600a8-0c9b-46d3-8bb4-8e03c7aa113f.png)\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/hankliu62/hankliu62.github.com/issues/65/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hankliu62/hankliu62.github.com/issues/65/timeline","performed_via_github_app":null,"state_reason":null},"menus":["## 背景","## 问题","## 解决方案","### 技术选择","### diff","#### 安装","#### 引用","#### API","#### 原理","### diff2html","#### 安装","#### 引用","#### 使用"]},"__N_SSG":true},"page":"/articles/[id]","query":{"id":"65"},"buildId":"qrQp_9Hjq-HbdXTrdq60c","assetPrefix":"/frontend","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>