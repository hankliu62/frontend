{"pageProps":{"article":{"url":"https://api.github.com/repos/hankliu62/hankliu62.github.com/issues/63","repository_url":"https://api.github.com/repos/hankliu62/hankliu62.github.com","labels_url":"https://api.github.com/repos/hankliu62/hankliu62.github.com/issues/63/labels{/name}","comments_url":"https://api.github.com/repos/hankliu62/hankliu62.github.com/issues/63/comments","events_url":"https://api.github.com/repos/hankliu62/hankliu62.github.com/issues/63/events","html_url":"https://github.com/hankliu62/hankliu62.github.com/issues/63","id":1443372566,"node_id":"I_kwDOBiJZIc5WCB4W","number":63,"title":"Webpack4升级到Webpack5","user":{"login":"hankliu62","id":8088864,"node_id":"MDQ6VXNlcjgwODg4NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/8088864?v=4","gravatar_id":"","url":"https://api.github.com/users/hankliu62","html_url":"https://github.com/hankliu62","followers_url":"https://api.github.com/users/hankliu62/followers","following_url":"https://api.github.com/users/hankliu62/following{/other_user}","gists_url":"https://api.github.com/users/hankliu62/gists{/gist_id}","starred_url":"https://api.github.com/users/hankliu62/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hankliu62/subscriptions","organizations_url":"https://api.github.com/users/hankliu62/orgs","repos_url":"https://api.github.com/users/hankliu62/repos","events_url":"https://api.github.com/users/hankliu62/events{/privacy}","received_events_url":"https://api.github.com/users/hankliu62/received_events","type":"User","site_admin":false},"labels":[{"id":688950687,"node_id":"MDU6TGFiZWw2ODg5NTA2ODc=","url":"https://api.github.com/repos/hankliu62/hankliu62.github.com/labels/blog","name":"blog","color":"1677ff","default":false,"description":"博客文章"}],"state":"open","locked":false,"assignee":{"login":"hankliu62","id":8088864,"node_id":"MDQ6VXNlcjgwODg4NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/8088864?v=4","gravatar_id":"","url":"https://api.github.com/users/hankliu62","html_url":"https://github.com/hankliu62","followers_url":"https://api.github.com/users/hankliu62/followers","following_url":"https://api.github.com/users/hankliu62/following{/other_user}","gists_url":"https://api.github.com/users/hankliu62/gists{/gist_id}","starred_url":"https://api.github.com/users/hankliu62/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hankliu62/subscriptions","organizations_url":"https://api.github.com/users/hankliu62/orgs","repos_url":"https://api.github.com/users/hankliu62/repos","events_url":"https://api.github.com/users/hankliu62/events{/privacy}","received_events_url":"https://api.github.com/users/hankliu62/received_events","type":"User","site_admin":false},"assignees":[{"login":"hankliu62","id":8088864,"node_id":"MDQ6VXNlcjgwODg4NjQ=","avatar_url":"https://avatars.githubusercontent.com/u/8088864?v=4","gravatar_id":"","url":"https://api.github.com/users/hankliu62","html_url":"https://github.com/hankliu62","followers_url":"https://api.github.com/users/hankliu62/followers","following_url":"https://api.github.com/users/hankliu62/following{/other_user}","gists_url":"https://api.github.com/users/hankliu62/gists{/gist_id}","starred_url":"https://api.github.com/users/hankliu62/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hankliu62/subscriptions","organizations_url":"https://api.github.com/users/hankliu62/orgs","repos_url":"https://api.github.com/users/hankliu62/repos","events_url":"https://api.github.com/users/hankliu62/events{/privacy}","received_events_url":"https://api.github.com/users/hankliu62/received_events","type":"User","site_admin":false}],"milestone":null,"comments":0,"created_at":"2022-11-10T07:11:02Z","updated_at":"2022-11-10T07:11:03Z","closed_at":null,"author_association":"OWNER","active_lock_reason":null,"body":"## 前言\r\n\r\n最近接手了公司内部webpack相关的依赖包，于是打算优化一波。考虑到webpack5已经正式发布近两年，跟webpack相关的依赖包应该适配的差不多了，于是打算先把webpack4升级到webpack5，然后基于webpack5再进行优化。\r\n升级前用的是 `\"webpack\": \"^4.39.3\" `，升级后用的是 `\"webpack\": \"^5.74.0\"` 。\r\n\r\n升级webpack的方法是先一键升级所有的依赖包，然后一个一个地去解决运行过程中的报错。\r\n\r\n首先，使用**npm-check-updates**工具：\r\n```\r\nnpx npm-check-updates -u\r\n```\r\n\r\n然后在项目中执行 `npx npm-check-updates -u` ，这样项目的package.json会把所有的依赖包都更新到最新版本，然后执行 yarn 。升级完就可以开启漫长的debug之旅了。\r\n\r\n## 记录\r\n\r\n### Webpack v5 VS v4 模块 ID\r\n\r\nWebpack v4 及之前的 moduleId 默认是自增的，例如 0.xxx.js、1.xxx.css、2.xxx.js 如果更改模块数量(即使内容没有变化)，也会导致模块文件重新发生改变，不利于长期缓存。\r\n不同的版本也提供了不同的解决方案，webpack v4 之前使用 HashedModuleIdsPlugin 插件覆盖默认的模块 ID 规则，在 webpack v4 中可以配置 optimization.moduleIds = 'hashed' 解决。这几种方案都是使用模块路径生成的 hash 做为 moduleId。\r\nWebpack v5 生产环境默认 optimization.moduleIds='deterministic' 无需更改。\r\n\r\n### Webpack v5 VS v4 Chunk ID\r\n\r\nwebpack v4 及之前的 chunkId 默认也是递增的，如果在 entry 配置中新增或删除一个元素，chunkId 也会随着递增或递减。\r\nwebpack v4 之前使用 NamedChunksPlugin 插件覆盖默认的 chunkId 规则，在 webpack v4 中可以配置 optimization.chunkIds = 'named' 解决。\r\n\r\nWebpack v5 生产环境默认 optimization.chunkIds='deterministic' 无需更改。\r\n\r\n### 真正的内容哈希\r\n\r\n另外，当使用 `[contenthash]` 时，webpack5 将使用真正的文件内容做为哈希值，这个类似于协商缓存 Etag，不一样的是还有一些优化，如果你只是删除了代码中的一些注释或重新命名变量，而这种情况代码逻辑是没有修改的，这些变化在压缩后是不可见的，不会导致 `[contenthash]` 也发生变化。\r\n如果是从 webpack v3 升级到 v5 的，HashedModuleIdsPlugin、NamedChunksPlugin 这些插件是可以去掉的，webpack v5 环境默认开启新的算法，无需再配置。\r\n参考文档 Webpack release 日志记录 — 重大变更：长期缓存[5]。\r\n\r\nhttps://www.51cto.com/article/670178.html\r\n\r\n## 升级问题记录\r\n\r\n### babel-plugin-import配置babel按需引入antd模块，编译后报错.bezierEasingMixin()\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/201014433-535d239c-e82a-4f07-8eaf-450cc4e8e77f.png)\r\n\r\n\r\n#### 解决方案：\r\n\r\n`https://github.com/ant-design/ant-motion/issues/44`\r\n\r\nless-loader 添加如下的options参数:\r\n\r\n``` webpack.config.js\r\n{\r\n    loader: 'less-loader',\r\n    options: {\r\n      lessOptions: {\r\n        javascriptEnabled: true\r\n      },\r\n    }\r\n},\r\n```\r\n\r\n### Error evaluating function `unit`: the first argument to unit must be a number. Have you forgotten parenthesis?\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/201014699-0da66a81-2d81-4e22-89fe-ff8f287b7537.png)\r\n\r\n#### 解决方案:\r\nhttps://blog.csdn.net/LiaoFengJi/article/details/113878788\r\n`https://github.com/ant-design/ant-design/issues/8162 `\r\n\r\nless-loader 添加如下的options参数(`math: 'always'`): \r\n\r\n``` webpack.config.js\r\n{\r\n    loader: 'less-loader',\r\n    options: {\r\n      lessOptions: {\r\n        javascriptEnabled: true,\r\n        math: 'always',\r\n      }\r\n    }\r\n},\r\n```\r\n\r\n### Module not found: Error: Can't resolve 'antd-mobile/lib/tab-bar/style' in '/Users/xxx/Workspace/xxx/xxx-platform-frontend-webpack5/xxx-web-admin2/src/h5'\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/201014977-66a13893-6952-4f7f-8764-83c88c2d2f04.png)\r\n\r\n\r\n#### 解决方案:\r\n\r\nhttps://mobile.ant.design/zh/guide/import-on-demand\r\n\r\n修改按需加载babel.config.js文件，如下所示：\r\n\r\n``` babel.config.js\r\nmodule.exports = {\r\n  \"plugins\": [\r\n    [\"import\", { \"libraryName\": \"antd-mobile\", \"libraryDirectory\": \"es/components\", \"style\": false}]\r\n  ]\r\n}\r\n```\r\n\r\n### Module not found: Error: Can't resolve 'antd-mobile/lib/flex' in '/Users/xxx/Workspace/xxx/xxx-platform-frontend-webpack5/xxx-web-admin2/src/h5/pages/brief'\r\n\r\n#### 解决方案：\r\nantd-mobile@4中使用`Grid` 组件 代替 `Flex` 组件\r\n\r\n``` tsx\r\n<Grid columns={2}>\r\n    <Grid.Item>\r\n      111\r\n    </Grid.Item>\r\n    <Grid.Item>\r\n      222\r\n    </Grid.Item>\r\n</Grid>\r\n```\r\n\r\n### Module not found: Error: Can't resolve 'tsparticles/Plugins/PolygonMask/Enums' in '/Users/xxx/Workspace/xxx/xxx-platform-frontend-webpack5/xxx-web-admin2/node_modules/react-particles-js/cjs'\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/201015389-d6dc20d5-fe2d-4635-8b86-8885bce2af40.png)\r\n\r\n\r\n#### 解决方案:\r\n\r\n`https://github.com/wufe/react-particles-js/issues/185`\r\n\r\n[react-particles-js](https://github.com/wufe/react-particles-js) 不再进行更新维护，替换成使用[react-tsparticles](https://www.npmjs.com/package/react-tsparticles) \r\n\r\n### 1 ERROR in child compilations (Use 'stats.children: true' resp. '--stats-children' for more details)\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/201015654-1c768f7b-d871-47cb-ba01-d2e5d1803721.png)\r\n\r\n#### 解决方案:\r\n暂无\r\n\r\n### ERROR in [eslint] Unexpected token ':'\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/201015836-ddf1148e-fe0f-46c3-8ceb-1332203ddf76.png)\r\n\r\n#### 解决方案:\r\n\r\nwebpack5中使用`eslint-webpack-plugin`代替`eslint-loader`\r\n\r\n``` webpack.config.js\r\nconst ESLintWebpackPlugin = require('eslint-webpack-plugin')\r\n\r\n// TODO: commit 之前会eslint提交的代码，没必要使用这个plugin，耗时\r\n\r\nnew ESLintWebpackPlugin({\r\n    context: path.resolve(__dirname, 'src'), // 文件根目录\r\n    extensions: ['js', 'jsx', 'ts', 'tsx'],\r\n}),\r\n```\r\n\r\n### ERROR in [eslint] ESLint is not a constructor\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/201016747-45208646-638a-4de7-8893-b1dff549380a.png)\r\n\r\n#### 解决方案:\r\n\r\nhttps://blog.csdn.net/LIZHUOLONG1/article/details/126021895\r\n`https://github.com/webpack-contrib/eslint-webpack-plugin/issues/147`\r\n\r\nwebpack5中使用`eslint-webpack-plugin`代替`eslint-loader`\r\n\r\n``` webpack.config.js\r\nconst ESLintWebpackPlugin = require('eslint-webpack-plugin')\r\n\r\n// TODO: commit 之前会eslint提交的代码，没必要使用这个plugin，耗时\r\n\r\nnew ESLintWebpackPlugin({\r\n    context: path.resolve(__dirname, 'src'), // 文件根目录\r\n    extensions: ['js', 'jsx', 'ts', 'tsx'],\r\n}),\r\n```\r\n\r\n### [DEP_WEBPACK_COMPILATION_OPTIMIZE_CHUNK_ASSETS] DeprecationWarning: optimizeChunkAssets is deprecated (use Compilation.hooks.processAssets instead and use one of Compilation.PROCESS_ASSETS_STAGE_* as stage option)\r\n\r\n#### 解决方案:\r\n\r\nhttp://events.jianshu.io/p/e79b8581eaae\r\n\r\n这是因为 `optimize-css-assets-webpack-plugin` 在webpack5中已不再友好支持\r\n使用 `css-minimizer-webpack-plugin` 为webpack5支持版\r\n\r\n``` webpack.config.js\r\noptimization: {\r\n    minimize: true,\r\n    minimizer: [\r\n        new CssMinimizerPlugin(),\r\n    ],\r\n }\r\n```\r\n\r\n### options has an unknown property 'disableHostCheck'. These properties are valid:\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/201016746-6fe68590-adbe-47ff-ab40-54eabe1dae18.png)\r\n\r\n#### 解决方案：\r\n`webpack.devServer` 中不支持 **disableHostCheck** 属性，删除，然后使用 **allowedHosts** 代替\r\n\r\n### options has an unknown property 'overlay'. These properties are valid:\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/201016879-bf225713-bbd7-45d5-b250-d5f9818f234e.png)\r\n\r\n#### 解决方案：\r\n\r\n`webpack.devServer` 中不支持 **overlay** 属性，删除\r\n\r\n### [webpack-cli] TypeError: Cannot read properties of undefined (reading 'tap')\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/201017044-6cb03849-9634-4e2f-9446-4f45a0c60bd8.png)\r\n\r\n#### 解决方案：\r\n\r\nwebpack5 中存在 `cache` 属性，支持进行持久化缓存优化\r\n\r\n删除 `hard-source-webpack-plugin` 插件\r\n\r\n```  webpack.config.js\r\n/**\r\n * 生成缓存版本\r\n *\r\n * @param {object} entry\r\n */\r\nfunction computeCacheVersion(entry) {\r\n  const hash = crypto.createHash('sha1')\r\n  hash.update(entry.usage) // 使用场景，如build、dev等\r\n  hash.update(entry.mode) // 编译模式\r\n  hash.update(entry.packageName) // 主包版本\r\n  hash.update(fs.readFileSync(path.join(entry.cwd, 'babel.config.js'))) // 用户babel编译文件\r\n  hash.update(fs.readFileSync(path.join(entry.cwd, 'tsconfig.json'))) // 用户ts配置文件\r\n  hash.update(fs.readFileSync(path.join(entry.cwd, 'node_modules', '.yarn-integrity'))) // 依赖信息\r\n  return hash.digest('hex')\r\n} \r\n\r\n// 缓存版本号\r\nconst cacheVersion = computeCacheVersion({\r\n  usage: JSON.stringify(process.env),\r\n  mode,\r\n  packageName: packageJSON.name,\r\n  cwd: path.resolve(__dirname),\r\n})\r\n\r\n// 缓存路径\r\nconst cacheDirectory = '/root/.npm/.webpack-cache/top-admin'\r\n\r\n// 打印webpack缓存版本\r\nconsole.log('WebpackCacheVersion', cacheVersion)\r\n\r\nfunction loggerCacheFile(dir) {\r\n  try {\r\n    const stat = fs.statSync(dir)\r\n    console.log(`cache directory, stat '${dir}'`)\r\n  } catch (error) {\r\n    console.log(`no such cache directory, stat '${dir}'`)\r\n  }\r\n}\r\n\r\nloggerCacheFile(cacheDirectory)\r\n...\r\n\r\n// webpack缓存属性\r\ncache: {\r\n    type: 'filesystem',\r\n    cacheDirectory: isDev ? path.resolve(__dirname, 'node_modules/.cache/webpack') : cacheDirectory,\r\n    version: cacheVersion,\r\n }\r\n```\r\n\r\n### export 'default' (imported as 'arrayMove') was not found in 'array-move' (possible exports: arrayMoveImmutable, arrayMoveMutable)\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/201017969-934b5490-16b9-4230-a0ce-42838de7de01.png)\r\n\r\n#### 解决方案：\r\n\r\n`array-move@4` 修改 **arrayMove** 方法的名称为 **arrayMoveImmutable**\r\n在引入的地方 `import arrayMove from 'array-move'` => `import { arrayMoveImmutable as arrayMove } from 'array-move'`\r\n\r\n### export 'createModel' (imported as 'createModel') was not found in 'hox' (possible exports: HoxRoot, createGlobalStore, createStore, withStore)\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/201017996-aad062a0-6104-4611-afe9-e6d5a2e873f6.png)\r\n\r\n#### 解决方案：\r\n\r\n在引入的地方，需要修改：  `import { createModel } from 'hox'` => `import { createGlobalStore as createModel } from 'hox'`；\r\n在调用的地方，**createGlobalStore**相当于一个自定义hooks，其定义为如下所示：\r\n``` ts\r\nexport declare function createGlobalStore<T>(hook: () => T): readonly [(depsFn?: DepsFn<T> | undefined) => T, () => T | undefined];\r\n```\r\n所以调用的地方，需要修改：`createModel(useGlobal)` => `createModel(useGlobal)[0]`\r\n\r\n#### export 'DropTarget' (imported as 'DropTarget') was not found in 'react-dnd' (possible exports: DndContext, DndProvider, DragPreviewImage, useDrag, useDragDropManager, useDragLayer, useDrop)\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/201019067-a6ad3351-98cb-4757-bed0-a803cfc27b17.png)\r\n\r\n解决方案：\r\n`\"react-dnd\": \"16\"` 和 `\"react-dnd-html5-backend\": \"16\"`相对于11版本的API有了很大的升级改动\r\n\r\n\r\n``` tsx\r\n// 老版本\r\nimport { DndProvider, DragSource, DropTarget } from 'react-dnd'\r\nimport { HTML5Backend } from 'react-dnd-html5-backend' \r\n\r\nlet dragingIndex = -1\r\n\r\nclass BodyRow extends React.Component {\r\n  render() {\r\n    const { isOver, connectDragSource, connectDropTarget, moveRow, ...restProps } = this.props\r\n    const style = { ...restProps.style, cursor: 'move' }\r\n\r\n    let { className } = restProps\r\n    if (isOver) {\r\n      if (restProps.index > dragingIndex) {\r\n        className += ' drop-over-downward'\r\n      }\r\n      if (restProps.index < dragingIndex) {\r\n        className += ' drop-over-upward'\r\n      }\r\n    }\r\n\r\n    return connectDragSource(connectDropTarget(<tr {...restProps} className={className} style={style} />))\r\n  }\r\n}\r\n\r\nconst rowTarget = {\r\n  drop(props, monitor) {\r\n    const dragIndex = monitor.getItem().index\r\n    const hoverIndex = props.index\r\n\r\n    // Don't replace items with themselves\r\n    if (dragIndex === hoverIndex) {\r\n      return\r\n    }\r\n\r\n    // Time to actually perform the action\r\n    props.moveRow(dragIndex, hoverIndex)\r\n\r\n    // Note: we're mutating the monitor item here!\r\n    // Generally it's better to avoid mutations,\r\n    // but it's good here for the sake of performance\r\n    // to avoid expensive index searches.\r\n    monitor.getItem().index = hoverIndex\r\n  },\r\n}\r\n\r\nconst rowSource = {\r\n  beginDrag(props) {\r\n    dragingIndex = props.index\r\n    return {\r\n      index: props.index,\r\n    }\r\n  },\r\n}\r\n\r\nconst DragableBodyRow = DropTarget('row', rowTarget, (connect, monitor) => ({\r\n  connectDropTarget: connect.dropTarget(),\r\n  isOver: monitor.isOver(),\r\n}))(\r\n  DragSource('row', rowSource, (connect) => ({\r\n    connectDragSource: connect.dragSource(),\r\n  }))(BodyRow),\r\n)\r\n\r\n<DndProvider backend={HTML5Backend}>\r\n    <Table\r\n      className={styles.list_table}\r\n      pagination={false}\r\n      columns={listTableColumns}\r\n      dataSource={data.items.map((item, index) => getTableItem(item, index))}\r\n      components={{\r\n        body: {\r\n          row: DragableBodyRow,\r\n        },\r\n      }}\r\n      onRow={(record, index) => ({\r\n        index,\r\n        moveRow: handleMoveItem,\r\n      })}\r\n    />\r\n </DndProvider>\r\n```\r\n\r\n``` tsx\r\n// 新版\r\n\r\nimport { DndProvider, useDrag, useDrop } from 'react-dnd'\r\nimport { HTML5Backend } from 'react-dnd-html5-backend'\r\n\r\nconst type = 'DraggableBodyRow';\r\n\r\nconst DragableBodyRow = ({ index, moveRow, className, style, ...restProps }) => {\r\n  const ref = useRef();\r\n  const [{ isOver, dropClassName }, drop] = useDrop({\r\n    accept: type,\r\n    collect: (monitor) => {\r\n      const { index: dragIndex } = monitor.getItem<{ index: number }>() || {};\r\n      if (dragIndex === index) {\r\n        return {};\r\n      }\r\n      return {\r\n        isOver: monitor.isOver(),\r\n        dropClassName: dragIndex < index ? ' drop-over-downward' : ' drop-over-upward',\r\n      };\r\n    },\r\n    drop: (item: any) => {\r\n      moveRow((item as any).index, index);\r\n    },\r\n  });\r\n  const [, drag] = useDrag({\r\n    type,\r\n    item: { index },\r\n    collect: monitor => ({\r\n      isDragging: monitor.isDragging(),\r\n    }),\r\n  });\r\n  drop(drag(ref));\r\n\r\n  return (\r\n    <tr\r\n      ref={ref}\r\n      className={`${className}${isOver ? dropClassName : ''}`}\r\n      style={{ cursor: 'move', ...style }}\r\n      {...restProps}\r\n    />\r\n  );\r\n};\r\n\r\n\r\n<DndProvider backend={HTML5Backend}>\r\n  <Table\r\n    className={styles.list_table}\r\n    pagination={false}\r\n    columns={listTableColumns}\r\n    dataSource={data.items.map((item, index) => getTableItem(item, index))}\r\n    components={{\r\n      body: {\r\n        row: DragableBodyRow,\r\n      },\r\n    }}\r\n    onRow={(record, index) => ({\r\n      index,\r\n      moveRow: handleMoveItem,\r\n    } as any)}\r\n  />\r\n</DndProvider>\r\n``` \r\n\r\n\r\n### Deprecation Using / for division is deprecated and will be removed in Dart Sass 2.0.0.\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/201020067-5f8087f2-faaf-426b-b0de-a4517f6e9a6f.png)\r\n\r\n#### 解决方案：\r\n\r\nhttps://blog.csdn.net/Tom__cy/article/details/122805775\r\n\r\n使用下列命令，更新`division`操作符\r\n\r\n``` bash\r\nnpx sass-migrator division ./src/**/*.scss\r\n```\r\n\r\n### Deprecation Using / for division is deprecated and will be removed in Dart Sass 2.0.0.  node_modules/@xxx/platform-common/lib/style/commons/layouts.scss\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/201020320-ff1c7646-bd33-4f18-83cb-a2e21fb6310d.png)\r\n\r\n\r\n#### 解决方案：\r\n\r\n1. 删除 \r\n\r\n``` scss\r\n@import '~@xxx/platform-common/lib/style/variables.scss';\r\n@import '~@xxx/platform-common/lib/style/mixins.scss';\r\n\r\n@import '@xx/platform-common/lib/style/index.scss';\r\n```\r\n\r\n2. 替换 @include clear-fix\r\n\r\n在 `xxx-web-admin2/src/common/scss/mixins.scss` 文件中加入，替换所有的`@include clear-fix`\r\n``` scss\r\n// 清除浮动\r\n@mixin clear-fix {\r\n  &:before,\r\n  &:after {\r\n    display: table;\r\n    content: \"\";\r\n    clear: both;\r\n  }\r\n}\r\n```\r\n\r\n3. 在全局scss文件中直接引入编译后的css文件\r\n```\r\n@import '@xx/platform-common/lib/style/index.css';\r\n```\r\n\r\n### (77:3) autoprefixer: Second Autoprefixer control comment was ignored. Autoprefixer applies control comment to whole block, not to next rules.\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/201020955-a1b857a3-fd7a-498e-be4a-ef2212f2fac7.png)\r\n\r\n#### 解决方案：\r\n\r\n替换下列SCSS代码为 `@include line-clamp(2);`\r\n\r\n``` scss\r\noverflow: hidden;\r\ntext-overflow: ellipsis;\r\ndisplay: -webkit-box; //将对象作为弹性伸缩盒子模型显示。\r\n/* autoprefixer: off */\r\n-webkit-box-orient: vertical; //从上到下垂直排列子元素（设置伸缩盒子的子元素排列方式）\r\n/* autoprefixer: on */\r\n-webkit-line-clamp: 2; //这个属性不是css的规范属性，需要组合上面两个属性，表示显示的行数。此处为2行\r\nword-wrap: break-word; //允许单词内断句，首先会尝试挪到下一行，看看下一行的宽度够不够，不够的话就进行单词内的断句\r\n```\r\n\r\n### Should not import the named export 'version' (imported as 'version') from default-exporting module (only default export is available soon)\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/201021162-afca58a1-72ce-4a7f-b987-dc283bd0200c.png)\r\n\r\n#### 解决方案：\r\n\r\nhttp://www.yanzw.cn/archives/reactantdantdesign3errorcneonfoe\r\n\r\nhttps://stackoverflow.com/questions/64993118/error-should-not-import-the-named-export-version-imported-as-version\r\n\r\n##### 1. Change the following\r\n\r\n``` tsx\r\nimport { version } from '../../package.json';\r\n```\r\n\r\nto something like\r\n\r\n```\r\nimport packageInfo from '../../package.json';\r\n```\r\n\r\nAnd then change your access from something like\r\n```\r\nversion,\r\n```\r\nor\r\n```\r\nversion: version,\r\n```\r\nto\r\n```\r\nversion: packageInfo.version,\r\n```\r\nAs noted in the comments, there may be cases where you do not want to expose your entire `package.json` file in the client code.\r\n\r\n##### 2. webpack加入下列属性:\r\n\r\nignoreWarnings: [\r\n    /only default export is available soon/,\r\n],\r\n\r\n### hard-source-webpack-plugin TypeError: Cannot read properties of undefined (reading 'tap')\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/201022339-a2a6c246-9b7c-4187-93fa-51bd4543eec3.png)\r\n\r\n#### 解决方案：\r\n\r\n`https://github.com/mzgoddard/hard-source-webpack-plugin/issues/546`\r\n\r\n#### 最终方案:\r\n\r\nwebpack5中可以使用Cache属性来缓存生成的 webpack 模块和 chunk，来改善构建速度。\r\n\r\n\r\n### Eslint error  Parsing error: require() of ES Module  dynamic import() which is available in all CommonJS modules\r\n\r\nParsing error: require() of ES Module /Users/xxx/Workspace/xxx/xxx-platform-frontend-webpack5/xxx-web-admin2/node_modules/eslint/node_modules/eslint-scope/lib/definition.js from /Users/xxx/Workspace/xxx/xxx-platform-frontend-webpack5/xxx-web-admin2/node_modules/babel-eslint/lib/require-from-eslint.js not supported.\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/201022525-9e8cd577-703c-4d23-8de1-47d147ba9c6e.png)\r\n\r\n#### 解决方案：\r\n\r\nwebpack5中使用`eslint-webpack-plugin`代替`eslint-loader`\r\n\r\n``` webpack.config.js\r\nconst ESLintWebpackPlugin = require('eslint-webpack-plugin')\r\n\r\n// TODO: commit 之前会eslint提交的代码，没必要使用这个plugin，耗时\r\n\r\nnew ESLintWebpackPlugin({\r\n    context: path.resolve(__dirname, 'src'), // 文件根目录\r\n    extensions: ['js', 'jsx', 'ts', 'tsx'],\r\n}),\r\n```\r\n\r\n### BREAKING CHANGE: No more changes should happen to Compilation.assets after sealing the Compilation.\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/201022680-2fac1cac-73b0-48da-97fc-0343df243ce2.png)\r\n\r\n#### 可能原因:\r\n\r\n`https://github.com/webpack/webpack/issues/11997`\r\n\r\n#### 解决方案：\r\n\r\n暂无解决\r\n\r\n#### HMR失效(Update failed: ChunkLoadError: Loading hot update chunk 179 failed.)\r\n\r\n每次启用liveReload\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/201022850-f251e7cf-8b92-4d1f-b317-4bc293e3975d.png)\r\n\r\n#### 解决方案：\r\n\r\nhttps://segmentfault.com/a/1190000041684579?sort=newest\r\n\r\n**css-leader**和**scss-loader**前不能使用**thread-loader**，否则不再同一个进程，无法进行HMR，只能回退成liveReload(刷新页面)\r\n\r\n#### 疑问：\r\n\r\n1. 为什么babel-loader前可以使用thread-loader且HMR也生效？\r\n\r\n### CICD持久化缓存优化\r\n\r\n![image](https://user-images.githubusercontent.com/8088864/201022850-f251e7cf-8b92-4d1f-b317-4bc293e3975d.png)\r\n\r\n#### 原因分析：\r\n\r\n1. 不能使用配置文件的方式进行缓存，CICD上每次编译时都会重新进行node_modules的安装，所以每次编译都没使用到缓存。\r\n2. **docker容器化部署，每次编译完缓存的文件未携带至下一次编译容器中(正确)**\r\n\r\n#### 解决方案：\r\n\r\n##### 问题一\r\n\r\nhttps://zhuanlan.zhihu.com/p/81122986\r\n\r\n##### 问题二\r\n\r\n修改`cacheDirectory`路径，改成 `'/root/.npm/.webpack-cache/top-admin'`\r\n\r\n\r\n疑问：\r\n1. 明明使用的是webpack.config.js配置文件的方式进行缓存，配置文件没有发生改变，为什么匹配不到缓存？\r\n\r\n\r\n## 参考文献\r\n\r\nhttp://www.45fan.com/article.php?aid=1D8hPfZrDF1Z3Pfq#_label8\r\nhttps://zhuanlan.zhihu.com/p/532825514\r\nhttps://blog.csdn.net/weixin_42192113/article/details/114645394\r\nhttps://wenku.baidu.com/view/a458d11cedfdc8d376eeaeaad1f34693daef10f7.html?_wkts_=1667373110609&bdQuery=eslint-webpack-plugin+webpack5\r\nhttp://www.icodebang.com/article/347305.html\r\nhttps://www.51cto.com/article/670178.html\r\nhttps://zhuanlan.zhihu.com/p/343079697\r\nhttps://blog.csdn.net/m0_37937502/article/details/124986762\r\nhttps://zhuanlan.zhihu.com/p/451435548\r\nhttp://www.wjhsh.net/wangpenghui522-p-14747627.html\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/hankliu62/hankliu62.github.com/issues/63/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/hankliu62/hankliu62.github.com/issues/63/timeline","performed_via_github_app":null,"state_reason":null},"menus":["## 前言","## 记录","### Webpack v5 VS v4 模块 ID","### Webpack v5 VS v4 Chunk ID","### 真正的内容哈希","## 升级问题记录","### babel-plugin-import配置babel按需引入antd模块，编译后报错.bezierEasingMixin()","#### 解决方案：","### Error evaluating function `unit`: the first argument to unit must be a number. Have you forgotten parenthesis?","#### 解决方案:","### Module not found: Error: Can't resolve 'antd-mobile/lib/tab-bar/style' in '/Users/xxx/Workspace/xxx/xxx-platform-frontend-webpack5/xxx-web-admin2/src/h5'","#### 解决方案:","### Module not found: Error: Can't resolve 'antd-mobile/lib/flex' in '/Users/xxx/Workspace/xxx/xxx-platform-frontend-webpack5/xxx-web-admin2/src/h5/pages/brief'","#### 解决方案：","### Module not found: Error: Can't resolve 'tsparticles/Plugins/PolygonMask/Enums' in '/Users/xxx/Workspace/xxx/xxx-platform-frontend-webpack5/xxx-web-admin2/node_modules/react-particles-js/cjs'","#### 解决方案:","### 1 ERROR in child compilations (Use 'stats.children: true' resp. '--stats-children' for more details)","#### 解决方案:","### ERROR in [eslint] Unexpected token ':'","#### 解决方案:","### ERROR in [eslint] ESLint is not a constructor","#### 解决方案:","### [DEP_WEBPACK_COMPILATION_OPTIMIZE_CHUNK_ASSETS] DeprecationWarning: optimizeChunkAssets is deprecated (use Compilation.hooks.processAssets instead and use one of Compilation.PROCESS_ASSETS_STAGE_* as stage option)","#### 解决方案:","### options has an unknown property 'disableHostCheck'. These properties are valid:","#### 解决方案：","### options has an unknown property 'overlay'. These properties are valid:","#### 解决方案：","### [webpack-cli] TypeError: Cannot read properties of undefined (reading 'tap')","#### 解决方案：","### export 'default' (imported as 'arrayMove') was not found in 'array-move' (possible exports: arrayMoveImmutable, arrayMoveMutable)","#### 解决方案：","### export 'createModel' (imported as 'createModel') was not found in 'hox' (possible exports: HoxRoot, createGlobalStore, createStore, withStore)","#### 解决方案：","#### export 'DropTarget' (imported as 'DropTarget') was not found in 'react-dnd' (possible exports: DndContext, DndProvider, DragPreviewImage, useDrag, useDragDropManager, useDragLayer, useDrop)","### Deprecation Using / for division is deprecated and will be removed in Dart Sass 2.0.0.","#### 解决方案：","### Deprecation Using / for division is deprecated and will be removed in Dart Sass 2.0.0.  node_modules/@xxx/platform-common/lib/style/commons/layouts.scss","#### 解决方案：","### (77:3) autoprefixer: Second Autoprefixer control comment was ignored. Autoprefixer applies control comment to whole block, not to next rules.","#### 解决方案：","### Should not import the named export 'version' (imported as 'version') from default-exporting module (only default export is available soon)","#### 解决方案：","##### 1. Change the following","##### 2. webpack加入下列属性:","### hard-source-webpack-plugin TypeError: Cannot read properties of undefined (reading 'tap')","#### 解决方案：","#### 最终方案:","### Eslint error  Parsing error: require() of ES Module  dynamic import() which is available in all CommonJS modules","#### 解决方案：","### BREAKING CHANGE: No more changes should happen to Compilation.assets after sealing the Compilation.","#### 可能原因:","#### 解决方案：","#### HMR失效(Update failed: ChunkLoadError: Loading hot update chunk 179 failed.)","#### 解决方案：","#### 疑问：","### CICD持久化缓存优化","#### 原因分析：","#### 解决方案：","##### 问题一","##### 问题二","## 参考文献"]},"__N_SSG":true}